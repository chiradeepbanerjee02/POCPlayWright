name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ['self-hosted', 'Windows', 'X64']
    
    permissions:
      contents: read
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check Python installation
      id: check-python
      run: |
        if command -v python3.10 &> /dev/null && python3.10 --version &> /dev/null; then
          echo "Python 3.10 already installed and functional"
          echo "python_installed=true" >> $GITHUB_OUTPUT
        else
          echo "Python 3.10 not found or not functional"
          echo "python_installed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Set up Python
      if: steps.check-python.outputs.python_installed != 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Check pip packages
      id: check-packages
      run: |
        # First ensure Python is available (either already installed or just set up)
        if ! command -v python3.10 &> /dev/null; then
          echo "Python 3.10 not available, packages will need to be installed"
          echo "packages_installed=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        all_installed=true
        for package in pytest playwright pytest-playwright pytest-html; do
          if ! python3.10 -m pip show "$package" &> /dev/null; then
            echo "Package $package not found"
            all_installed=false
            break
          fi
        done
        if [ "$all_installed" = true ]; then
          echo "All required packages already installed"
          echo "packages_installed=true" >> $GITHUB_OUTPUT
        else
          echo "Some packages need installation"
          echo "packages_installed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Install dependencies
      if: steps.check-packages.outputs.packages_installed != 'true'
      run: |
        python3.10 -m pip install --upgrade pip
        python3.10 -m pip install pytest playwright pytest-playwright pytest-html
    
    - name: Check Playwright browser
      id: check-browser
      run: |
        # Check if chromium directory exists in the Playwright cache
        if [ -d "$HOME/.cache/ms-playwright" ] && compgen -G "$HOME/.cache/ms-playwright/chromium-*" > /dev/null 2>&1; then
          echo "Chromium browser already installed"
          echo "browser_installed=true" >> $GITHUB_OUTPUT
        else
          echo "Chromium browser not found"
          echo "browser_installed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Install Playwright browsers
      if: steps.check-browser.outputs.browser_installed != 'true'
      run: |
        playwright install chromium
        playwright install-deps chromium || echo "Browser dependencies may need manual installation"
        
    - name: Run tests
      working-directory: ./POC-PW
      run: |
        pytest --html=reports/report.html --self-contained-html
        
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-test-reports
        path: POC-PW/reports/
        retention-days: 30
