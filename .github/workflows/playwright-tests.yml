name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ['self-hosted', 'Windows', 'X64']
    
    permissions:
      contents: read
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check Python installation
      id: check-python
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        try {
          $pythonVersion = & python --version 2>&1
          if ($pythonVersion -match "Python 3\.10") {
            Write-Host "Python 3.10 already installed and functional"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "python_installed=true"
          } else {
            Write-Host "Python 3.10 not found or not functional"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "python_installed=false"
          }
        } catch {
          Write-Host "Python 3.10 not found or not functional"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "python_installed=false"
        }
        
    - name: Set up Python
      if: steps.check-python.outputs.python_installed != 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Check pip packages
      id: check-packages
      shell: pwsh
      run: |
        # First ensure Python is available (either already installed or just set up)
        try {
          $null = & python --version 2>&1
        } catch {
          Write-Host "Python not available, packages will need to be installed"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "packages_installed=false"
          exit 0
        }
        
        $allInstalled = $true
        $packages = @("pytest", "playwright", "pytest-playwright", "pytest-html")
        foreach ($package in $packages) {
          try {
            $null = & python -m pip show $package 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Package $package not found"
              $allInstalled = $false
              break
            }
          } catch {
            Write-Host "Package $package not found"
            $allInstalled = $false
            break
          }
        }
        if ($allInstalled) {
          Write-Host "All required packages already installed"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "packages_installed=true"
        } else {
          Write-Host "Some packages need installation"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "packages_installed=false"
        }
        
    - name: Install dependencies
      if: steps.check-packages.outputs.packages_installed != 'true'
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        python -m pip install pytest playwright pytest-playwright pytest-html
    
    - name: Check Playwright browser
      id: check-browser
      shell: pwsh
      run: |
        # Check if chromium directory exists in the Playwright cache (Windows location)
        $playwrightPath = "$env:LOCALAPPDATA\ms-playwright"
        if (Test-Path $playwrightPath) {
          $chromiumDirs = Get-ChildItem -Path $playwrightPath -Filter "chromium-*" -ErrorAction SilentlyContinue
          if ($chromiumDirs) {
            Write-Host "Chromium browser already installed"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "browser_installed=true"
          } else {
            Write-Host "Chromium browser not found"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "browser_installed=false"
          }
        } else {
          Write-Host "Chromium browser not found"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "browser_installed=false"
        }
        
    - name: Install Playwright browsers
      if: steps.check-browser.outputs.browser_installed != 'true'
      shell: pwsh
      run: |
        playwright install chromium
        $ErrorActionPreference = 'Continue'
        playwright install-deps chromium 2>&1 | Out-Null
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Browser dependencies may need manual installation"
        }
        
    - name: Run tests
      working-directory: ./POC-PW
      shell: pwsh
      run: |
        pytest --html=reports/report.html --self-contained-html
        
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-test-reports
        path: POC-PW/reports/
        retention-days: 30
