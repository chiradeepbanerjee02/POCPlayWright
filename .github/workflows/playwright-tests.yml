name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ['self-hosted', 'Windows', 'X64']
    
    permissions:
      contents: read
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check Python installation
      id: check-python
      shell: pwsh
      run: |
        $found = $false
        # Try 'python' command
        $cmd = Get-Command python -ErrorAction SilentlyContinue
        if ($cmd) {
            $ver = & $cmd.Source --version 2>&1
            if ($ver -match "3\.10") { 
                Write-Host "Python 3.10 found at $($cmd.Source)"
                $found = $true 
            }
        }
        
        # Try 'py' launcher if 'python' didn't match
        if (-not $found) {
            $pyCmd = Get-Command py -ErrorAction SilentlyContinue
            if ($pyCmd) {
                $ver = & $pyCmd.Source -3.10 --version 2>&1
                if ($ver -match "3\.10") { 
                    Write-Host "Python 3.10 found via 'py' launcher"
                    $found = $true 
                }
            }
        }
        
        if ($found) {
          Add-Content -Path $env:GITHUB_OUTPUT -Value "python_installed=true"
        } else {
          Write-Host "Python 3.10 not found or not functional in PATH"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "python_installed=false"
        }
        
    - name: Set up Python
      if: steps.check-python.outputs.python_installed != 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Check pip packages
      id: check-packages
      shell: pwsh
      run: |
        $pythonCmd = if (Get-Command python -ErrorAction SilentlyContinue) { "python" } else { "py -3.10" }
        
        $allInstalled = $true
        $packages = @("pytest", "playwright", "pytest-playwright", "pytest-html")
        foreach ($package in $packages) {
          try {
            $null = & $pythonCmd -m pip show $package 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Package $package not found"
              $allInstalled = $false
              break
            }
          } catch {
            $allInstalled = $false
            break
          }
        }
        if ($allInstalled) {
          Write-Host "All required packages already installed"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "packages_installed=true"
        } else {
          Add-Content -Path $env:GITHUB_OUTPUT -Value "packages_installed=false"
        }
        
    - name: Install dependencies
      if: steps.check-packages.outputs.packages_installed != 'true'
      shell: pwsh
      run: |
        $pythonCmd = if (Get-Command python -ErrorAction SilentlyContinue) { "python" } else { "py -3.10" }
        & $pythonCmd -m pip install --upgrade pip
        & $pythonCmd -m pip install pytest playwright pytest-playwright pytest-html
    
    - name: Check Playwright browser
      id: check-browser
      shell: pwsh
      run: |
        $playwrightPath = "$env:LOCALAPPDATA\ms-playwright"
        if (Test-Path $playwrightPath) {
          $chromiumDirs = Get-ChildItem -Path $playwrightPath -Filter "chromium-*" -ErrorAction SilentlyContinue
          if ($chromiumDirs) {
            Write-Host "Chromium browser already installed"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "browser_installed=true"
            exit 0
          }
        }
        Add-Content -Path $env:GITHUB_OUTPUT -Value "browser_installed=false"
        
    - name: Install Playwright browsers
      if: steps.check-browser.outputs.browser_installed != 'true'
      shell: pwsh
      run: |
        playwright install chromium
        
    - name: Run tests
      working-directory: ./POC-PW
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        # Ensure reports directory exists
        if (!(Test-Path "reports")) { New-Item -ItemType Directory -Path "reports" }
        pytest --html=reports/report.html --self-contained-html
        
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-test-reports
        path: POC-PW/reports/
        retention-days: 30
